{% extends 'movies/base.html' %}

{% block title %}My Watchlist - Movie Hub{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-heart text-danger me-2"></i>My Watchlist</h2>
        <span class="badge bg-primary">{{ watchlist_count }} movie{{ watchlist_count|pluralize }}</span>
      </div>

      {% if watchlist_items %}
        <div class="row">
          {% for item in watchlist_items %}
            <div class="col-lg-3 col-md-4 col-sm-6 mb-4" id="movie-card-{{ item.movie.pk }}">
              <div class="card movie-card h-100 shadow-sm border-0">
                {% if item.movie.poster %}
                  <img src="{{ item.movie.poster.url }}" class="card-img-top movie-poster" alt="{{ item.movie.title }}">
                {% else %}
                  <div class="card-img-top movie-poster bg-secondary d-flex align-items-center justify-content-center">
                    <i class="fas fa-film fa-3x text-white"></i>
                  </div>
                {% endif %}
                <div class="card-body">
                  <h5 class="card-title fw-semibold">{{ item.movie.title }}</h5>
                  <p class="card-text text-muted">{{ item.movie.description|truncatewords:15 }}</p>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">{{ item.movie.category.name }}</small>
                    <span class="rating-stars text-warning">
                      {% for i in "12345"|make_list %}
                        {% if forloop.counter <= item.movie.average_rating %}
                          <i class="fas fa-star"></i>
                        {% else %}
                          <i class="far fa-star"></i>
                        {% endif %}
                      {% endfor %}
                      <small class="ms-1 text-muted">({{ item.movie.total_ratings }})</small>
                    </span>
                  </div>
                  <small class="text-muted">Added: {{ item.added_at|date:"M d, Y" }}</small>
                </div>
                <div class="card-footer bg-white border-0">
                  <div class="btn-group w-100">
                    <a href="{% url 'movie_detail' item.movie.pk %}" class="btn btn-primary btn-sm fw-semibold">
                      <i class="fas fa-play me-2"></i>View
                    </a>
                    <button class="btn btn-outline-danger btn-sm fw-semibold d-flex align-items-center justify-content-center gap-1"
                            onclick="removeFromWatchlist({{ item.movie.pk }})">
                      <i id="heart-icon-{{ item.movie.pk }}" class="fas fa-heart text-danger"></i>
                      Remove
                    </button>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-5">
          <i class="fas fa-heart fa-4x text-muted mb-3"></i>
          <h4>Your watchlist is empty</h4>
          <p class="text-muted mb-4">Start adding movies to your watchlist to keep track of what you want to watch!</p>
          <a href="{% url 'home' %}" class="btn btn-primary">Browse Movies</a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ✅ Toast Container -->
<div id="toast-container"></div>

<script>
function removeFromWatchlist(movieId) {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
  if (!csrfToken) {
    alert("CSRF token missing. Please refresh the page.");
    return;
  }

  const card = document.getElementById(`movie-card-${movieId}`);
  const heartIcon = document.getElementById(`heart-icon-${movieId}`);

  // Animate heart
  heartIcon.classList.add("heart-fade");

  setTimeout(() => {
    fetch(`/movie/${movieId}/watchlist/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Animate card removal
        card.classList.add("fade-out");
        setTimeout(() => card.remove(), 400);

        showToast(`Removed "${data.movie_title || 'Movie'}" from your Watchlist ❤️`);

        // Update count badge
        const countBadge = document.querySelector(".badge.bg-primary");
        let count = parseInt(countBadge.textContent);
        countBadge.textContent = `${count - 1} movie${count - 1 !== 1 ? 's' : ''}`;

        // If all removed, show empty state
        if (document.querySelectorAll(".movie-card").length === 1) {
          document.querySelector(".container").insertAdjacentHTML(
            "beforeend",
            `
            <div class="text-center py-5 fade-in">
              <i class="fas fa-heart fa-4x text-muted mb-3"></i>
              <h4>Your watchlist is empty</h4>
              <p class="text-muted mb-4">Start adding movies to your watchlist to keep track of what you want to watch!</p>
              <a href="/" class="btn btn-primary">Browse Movies</a>
            </div>
            `
          );
        }
      } else {
        showToast("Error: " + data.error, true);
      }
    })
    .catch(error => {
      console.error("Error:", error);
      showToast("Error removing movie. Try again!", true);
    });
  }, 250);
}

// ✅ Toast notification function
function showToast(message, isError = false) {
  const toast = document.createElement("div");
  toast.className = `toast-message ${isError ? 'error' : ''}`;
  toast.innerHTML = `
    <i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'} me-2"></i>${message}
  `;

  document.getElementById("toast-container").appendChild(toast);

  setTimeout(() => {
    toast.classList.add("show");
  }, 100);

  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 500);
  }, 2500);
}
</script>

<style>
/* ❤️ Heart fade animation */
.heart-fade {
  animation: fadeHeart 0.4s ease forwards;
  color: #e50914 !important;
}
@keyframes fadeHeart {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.3); opacity: 0.8; }
  100% { transform: scale(0.8); opacity: 0; }
}

/* Card fade-out */
.fade-out {
  animation: fadeOutCard 0.4s ease forwards;
}
@keyframes fadeOutCard {
  from { opacity: 1; transform: scale(1); }
  to { opacity: 0; transform: scale(0.9); height: 0; margin: 0; }
}

/* Toast notifications */
#toast-container {
  position: fixed;
  bottom: 30px;
  right: 30px;
  z-index: 9999;
}

.toast-message {
  background: rgba(40, 167, 69, 0.95);
  color: #fff;
  padding: 12px 18px;
  border-radius: 8px;
  margin-top: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  opacity: 0;
  transform: translateX(50px);
  transition: all 0.4s ease;
  display: flex;
  align-items: center;
  font-weight: 500;
}

.toast-message.error {
  background: rgba(220, 53, 69, 0.95);
}

.toast-message.show {
  opacity: 1;
  transform: translateX(0);
}

/* Empty state animation */
.fade-in {
  animation: fadeIn 0.6s ease forwards;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}
