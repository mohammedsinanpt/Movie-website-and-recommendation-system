{% extends 'movies/base.html' %}

{% block title %}{{ movie.title }} - Movie Hub{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <!-- Poster Section -->
    <div class="col-md-4">
      {% if movie.poster %}
        <img src="{{ movie.poster.url }}" class="img-fluid rounded shadow-sm" alt="{{ movie.title }}">
      {% else %}
        <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="height: 400px;">
          <i class="fas fa-film fa-4x text-white"></i>
        </div>
      {% endif %}

      <!-- Watchlist Button -->
      {% if user.is_authenticated %}
        <div class="mt-3">
         <button id="watchlist-btn-{{ movie.pk }}"
        class="btn {% if in_watchlist %}btn-danger active{% else %}btn-outline-primary{% endif %} w-100 d-flex align-items-center justify-content-center gap-2"
        onclick="toggleWatchlist({{ movie.pk }})">
  <i id="heart-icon-{{ movie.pk }}" class="fas fa-heart{% if not in_watchlist %} text-muted{% endif %}"></i>
  <span id="watchlist-text-{{ movie.pk }}">
    {% if in_watchlist %}Remove from Watchlist{% else %}Add to Watchlist{% endif %}
  </span>
</button>

        </div>
      {% endif %}
    </div>

    <!-- Movie Info Section -->
    <div class="col-md-8">
      <h1 class="fw-bold">{{ movie.title }}</h1>
      <p class="text-muted">{{ movie.category.name }} ‚Ä¢ {{ movie.release_date|date:"Y" }}</p>

      <!-- Rating Section -->
      <div class="mb-4">
        <div class="row">
          <div class="col-md-6">
            <h5>Average Rating</h5>
            <div class="d-flex align-items-center mb-2">
              <div class="rating-display me-3">
                {% for i in "12345"|make_list %}
                  <i class="fas fa-star {% if forloop.counter <= average_rating %}text-warning{% else %}text-muted{% endif %}"></i>
                {% endfor %}
                <span class="ms-2">{{ average_rating }}/5 ({{ total_ratings }} rating{{ total_ratings|pluralize }})</span>
              </div>
            </div>
          </div>

          {% if user.is_authenticated %}
          <div class="col-md-6">
            <h5>Your Rating</h5>
            <div class="rating-input">
              {% for i in "12345"|make_list %}
                <i class="fas fa-star rating-star {% if forloop.counter <= user_rating %}text-warning{% else %}text-muted{% endif %}"
                   data-rating="{{ forloop.counter }}"
                   onclick="rateMovie({{ movie.pk }}, {{ forloop.counter }})"></i>
              {% endfor %}
              <div id="rating-message" class="mt-2"></div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="mb-3">
        <h5>Description</h5>
        <p>{{ movie.description }}</p>
      </div>

      <div class="mb-3">
        <h5>Cast</h5>
        <p>{{ movie.actors }}</p>
      </div>

      {% if movie.youtube_trailer %}
      <div class="mb-3">
        <h5>Trailer</h5>
        <a href="{{ movie.youtube_trailer }}" target="_blank" class="btn btn-outline-danger">
          <i class="fab fa-youtube me-2"></i>Watch Trailer
        </a>
      </div>
      {% endif %}

      <div class="mb-3">
        <small class="text-muted">
          Added by {{ movie.added_by.first_name|default:movie.added_by.username }}
          on {{ movie.created_at|date:"F d, Y" }}
        </small>
      </div>

      {% if can_edit %}
      <div class="mb-3">
        <a href="{% url 'edit_movie' movie.pk %}" class="btn btn-warning">
          <i class="fas fa-edit me-2"></i>Edit Movie
        </a>
        <a href="{% url 'delete_movie' movie.pk %}" class="btn btn-danger">
          <i class="fas fa-trash me-2"></i>Delete Movie
        </a>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Reviews Section -->
  <div class="row mt-5">
    <div class="col-12">
      <h3 class="fw-bold mb-4">Reviews</h3>

      {% if user.is_authenticated %}
        <div class="mb-4 review-section">
          {% if user_review %}
            <!-- Your Review Card -->
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
              <div class="card-header bg-white d-flex justify-content-between align-items-center border-0 pb-0">
                <h6 class="fw-bold text-dark mb-0">
                  <i class="fas fa-comment-dots text-primary me-2"></i>Your Review
                </h6>
                <div>
                  <a href="{% url 'add_review' movie.pk %}" class="btn btn-sm btn-light border text-primary fw-semibold me-2">
                    <i class="fas fa-edit me-1"></i>Edit
                  </a>
                  <a href="{% url 'delete_review' user_review.pk %}" class="btn btn-sm btn-light border text-danger fw-semibold">
                    <i class="fas fa-trash me-1"></i>Delete
                  </a>
                </div>
              </div>
              <div class="card-body">
                <p class="mb-2 text-secondary fs-6">{{ user_review.review_text }}</p>
                <small class="text-muted">
                  <i class="far fa-clock me-1"></i>Last updated: {{ user_review.updated_at|date:"F d, Y" }}
                </small>
              </div>
            </div>
          {% else %}
            <!-- Write Review Button -->
            <div class="text-center mt-4">
              <a href="{% url 'add_review' movie.pk %}" class="btn btn-gradient fw-semibold px-4 py-2 shadow-sm rounded-3">
                <i class="fas fa-pen me-2"></i>Write a Review
              </a>
            </div>
          {% endif %}
        </div>
      {% endif %}

      <!-- Other Users‚Äô Reviews -->
      {% if reviews %}
        {% for review in reviews %}
          {% if review.user != user %}
          <div class="card border-0 shadow-sm rounded-4 mb-3">
            <div class="card-header bg-white border-0">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-semibold">{{ review.user.first_name|default:review.user.username }}</h6>
                <small class="text-muted">{{ review.created_at|date:"F d, Y" }}</small>
              </div>
            </div>
            <div class="card-body bg-light">
              <p class="mb-0 text-secondary">{{ review.review_text }}</p>
            </div>
          </div>
          {% endif %}
        {% endfor %}
      {% else %}
        {% if not user_review %}
        <p class="text-muted fst-italic">No reviews yet. Be the first to share your thoughts on this movie üé¨</p>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<!-- Custom Styles -->
<style>
  body {
    background-color: #f8f9fb;
  }

  .card {
    border-radius: 1rem;
    transition: all 0.3s ease;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
  }

  .review-section .btn-gradient {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
    border: none;
    transition: all 0.3s ease;
  }

  .review-section .btn-gradient:hover {
    background: linear-gradient(135deg, #5a6fe0, #6b4098);
    box-shadow: 0 4px 12px rgba(118, 75, 162, 0.4);
    transform: translateY(-1px);
  }

  .review-section .card-body {
    background-color: #fcfcfc;
  }

  .review-section small {
    font-size: 0.85rem;
  }

  .rating-input i {
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .rating-input i:hover {
    transform: scale(1.2);
  }
</style>



<script>
function rateMovie(movieId, rating) {
  fetch(`/movie/${movieId}/rate/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify({rating: rating})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.querySelectorAll('.rating-star').forEach((star, index) => {
        if (index < rating) {
          star.classList.add('text-warning');
          star.classList.remove('text-muted');
        } else {
          star.classList.add('text-muted');
          star.classList.remove('text-warning');
        }
      });

      document.querySelectorAll('.rating-display i').forEach((star, index) => {
        if (index < Math.floor(data.average_rating)) {
          star.classList.add('text-warning');
          star.classList.remove('text-muted');
        } else {
          star.classList.add('text-muted');
          star.classList.remove('text-warning');
        }
      });

      document.querySelector('.rating-display span').textContent =
        `${data.average_rating}/5 (${data.total_ratings} rating${data.total_ratings !== 1 ? 's' : ''})`;

      document.getElementById('rating-message').innerHTML =
        `<small class="text-success">${data.message}</small>`;

      setTimeout(() => {
        document.getElementById('rating-message').innerHTML = '';
      }, 3000);
    }
  })
  .catch(error => console.error('Error rating movie:', error));
}

// ‚úÖ Netflix-style Add/Remove Watchlist Button
function toggleWatchlist(movieId) {
 const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');


  const button = document.getElementById(`watchlist-btn-${movieId}`);
  const text = document.getElementById(`watchlist-text-${movieId}`);
  const heart = document.getElementById(`heart-icon-${movieId}`);

  fetch(`/movie/${movieId}/watchlist/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      if (data.in_watchlist) {
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-danger', 'active');
        heart.classList.remove('text-muted');
        heart.classList.add('heart-animate');
        text.textContent = 'Remove from Watchlist';
      } else {
        button.classList.remove('btn-danger', 'active');
        button.classList.add('btn-outline-primary');
        heart.classList.add('text-muted');
        text.textContent = 'Add to Watchlist';
      }
    } else {
      alert("Error: " + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error toggling watchlist');
  });
}
</script>

<style>
/* ‚ù§Ô∏è Heart animation */
.heart-animate {
  animation: popHeart 0.5s ease;
  color: #ff4d6d !important;
}
@keyframes popHeart {
  0% { transform: scale(1); }
  40% { transform: scale(1.4); }
  60% { transform: scale(0.9); }
  80% { transform: scale(1.2); }
  100% { transform: scale(1); }
}
</style>
{% endblock %}
